How to setup a cgminer for solo mining to bitcoind using Ubuntu 22.04 Server

Software
========
Short hardware comment:
Your mining computer will need at least 2GB RAM and around 500GB storage
for the blockchain.

1) Download the Ubuntu 22.04 LTS server installtion media and perform a
   minimum install on a physical computer or a virtual machine
   ( https://ubuntu.com/download/server )

2) Once installed, add the nftables firewall and create /etc/nftables.conf

	sudo apt install nftables
	sudo sh -c 'echo "\
	#\!/usr/sbin/nft -f\\n\
	\\n\
	flush ruleset\\n\
	\\n\
	include \"/etc/nftables.blacklist_ipv4\"\\n\
	include \"/etc/nftables.blacklist_ipv6\"\\n\
	\\n\
	table inet filter {\\n\
		set blacklist_ipv4 {\\n\
			type ipv4_addr; flags interval; counter;\\n\
			elements = $blacklist_ipv4\\n\
		}\\n\
		set blacklist_ipv6 {\\n\
			type ipv6_addr; flags interval; counter;\\n\
			elements = $blacklist_ipv6\\n\
		}\\n\
	\\n\
		chain input {\\n\
			type filter hook input priority 0; policy drop;\\n\
			iif lo accept\\n\
			ct state vmap { established : accept, related : accept, invalid : drop }\\n\
	\\n\
			ip saddr @blacklist_ipv4 drop\\n\
			ip6 saddr @blacklist_ipv6 drop\\n\
	\\n\
			meta l4proto { icmp, ipv6-icmp } accept\\n\
	\\n\
			tcp dport { 8333, 18333 } accept\\n\
	\\n\
			tcp dport ssh accept\\n\
		}\\n\
		chain output {\\n\
			type filter hook output priority 0; policy drop;\\n\
			oif lo accept\\n\
			ct state established,related accept\\n\
	\\n\
			ip daddr @blacklist_ipv4 drop\\n\
			ip6 daddr @blacklist_ipv6 drop\\n\
	\\n\
			meta l4proto { icmp, ipv6-icmp } accept\\n\
	\\n\
			tcp dport { http, 8333, 18333 } accept\\n\
	\\n\
			meta l4proto { tcp, udp } th dport domain accept\\n\
			tcp dport smtp accept\\n\
		}\\n\
	}\
	" > /etc/nftables.conf'
	sudo chmod 700 /etc/nftables.conf

3) Create /etc/nftables.blacklist_ipv4 and /etc/nftables.blacklist_ipv6
   to prevent traffic to and from known malicious networks and jurisdictions
   that are under sanctions

4) Start the nftables firewall

	systemctl enable --now nftables.service

5) Install packages to meet cgminer and bitcoind runtime requirements

	# Runtime dependencies for cgminer
	sudo apt install libjansson4
	# Runtime dependencies for bitcoind
	sudo apt install libevent-pthreads-2.1-7
	sudo apt install libevent-2.1-7
	sudo apt install libzmq5

6) Add users for cgminer and bitcoind

	sudo useradd -M -r -s /usr/sbin/nologin -d /var/lib/bitcoind -c "bitcoin daemon" bitcoin
	sudo useradd -N -M -r -s /usr/sbin/nologin -d /nonexistent -g bitcoin -c cgminer cgminer

7) Copy contrib/init/bitcoind.service to /etc/systemd/system/ and ensure paths
   are correct. You may also want to add -nodebuglogfile to ExecStart
   ( https://raw.githubusercontent.com/bitcoin/bitcoin/master/contrib/init/bitcoind.service )

	sudo sh -c 'sed "s:/usr/bin/bitcoind :/usr/local/bin/bitcoind :g" contrib/init/bitcoind.service > /etc/systemd/system/bitcoind.service'

8) Copy cgminer.service to /etc/systemd/system/ and ensure paths are correct.
   The cgminer service needs the screen package
   ( https://raw.githubusercontent.com/cmmodtools/cgminer/master/cgminer.service )

	sudo apt install screen
	sudo cp cgminer.service /etc/systemd/system/

9) Create a restricted /etc/bitcoin directory for configuration files and
   generate bitcoin.conf. The below enables dual stack operation and enables
   pruning to 455000MiB
   ( https://raw.githubusercontent.com/bitcoin/bitcoin/master/share/examples/bitcoin.conf )

	sudo install -d -o root -g bitcoin -m 710 /etc/bitcoin
	sudo sh -c 'sed "s/^#bind=<addr>/bind=0.0.0.0\nbind=[::]/; s/^#prune=/prune=455000/" share/examples/bitcoin.conf > /etc/bitcoin/bitcoin.conf'
	sudo chgrp bitcoin /etc/bitcoin/bitcoin.conf
	sudo chmod 640 /etc/bitcoin/bitcoin.conf

10) Copy example.conf to /etc/bitcoin
    ( https://raw.githubusercontent.com/cmmodtools/cgminer/master/example.conf )

	sudo cp example.conf /etc/bitcoi/cgminer.conf
	sudo chgrp bitcoin /etc/bitcoin/cgminer.conf
	sudo chmod 640 /etc/bitcoin/cgminer.conf

11) Create RPC credentials for cgminer and edit bitcon.conf and cgminer.conf
    with the values
   ( https://raw.githubusercontent.com/bitcoin/bitcoin/master/share/rpcauth/rpcauth.py )

	rpcauth.py cgminer

12) Start bitcoind

	sudo systemctl daemon-reload
	sudo systemctl enable --now bitcoind

13) Create a wallet for cgminer, encrypt it with a password and add the
    address to cgminer.conf

	bitcoin-cli createwallet "cgminer"
	bitcoin-cli getnewaddress "cgminer" legacy
	14R8yoc7PuxLQmMz1TNNKtz3BsJVs1Mzjp
	bitcoin-cli -stdin encryptwallet

14) Copy 01-cgminer.rules to /etc/udev/rules.d/ and check to see your USB miners
   are detected
   ( https://raw.githubusercontent.com/cmmodtools/cgminer/master/01-cgminer.rules )

	sudo cp 01-cgminer.rules /etc/udev/rules.d/
	sudo lsusb

15) Start cgminer and view its output

	sudo systemctl enable --now bitcoind
	sudo -u cgminer screen -r cgminer

